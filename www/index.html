<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADR Bot â€” Architecture Decision Records</title>
  <link rel="icon" type="image/png" href="adr-bot-icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <a href="index.html" class="topbar-brand">
        <img src="adr-bot-icon.png" alt="ADR Bot" class="topbar-icon">
        <span>ADR Bot</span>
      </a>
      <nav class="topbar-nav">
        <a href="index.html" class="active">Dashboard</a>
        <a href="about.html">About</a>
      </nav>
      <span class="topbar-user"><span id="user-info"></span><button class="topbar-signout" onclick="signOut()" title="Sign out">Sign out</button></span>
    </header>

    <div id="auth" class="auth-card">
      <img src="adr-bot-icon.png" alt="ADR Bot" class="auth-logo">
      <h2>ADR Bot</h2>
      <p class="auth-tagline">Architecture Decision Records for your team</p>
      <p>Sign in with your Slack workspace account.</p>
      <button class="btn btn-primary btn-slack" onclick="signInWithSlack()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zm-1.27 0a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.163 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.163 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.163 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zm0-1.27a2.527 2.527 0 0 1-2.52-2.523 2.527 2.527 0 0 1 2.52-2.52h6.315A2.528 2.528 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.315z"/></svg>
        Sign in with Slack
      </button>
      <p id="auth-msg" class="hidden mt-2"></p>
    </div>

    <div id="app" class="hidden">
      <div class="page-header fade-in">
        <h1>Dashboard</h1>
        <p>Architecture Decision Records across your workspace</p>
      </div>

      <div id="msg"></div>

      <div class="card fade-in fade-in-1">
        <div class="card-header">
          <h3>Decision Records</h3>
        </div>
        <div class="filter-bar">
          <div class="filter-group">
            <label for="filter-state">State</label>
            <select id="filter-state">
              <option value="">All</option>
              <option value="DRAFT">Draft</option>
              <option value="ACCEPTED">Accepted</option>
              <option value="REJECTED">Rejected</option>
              <option value="SUPERSEDED">Superseded</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-search">Search</label>
            <input type="text" id="filter-search" placeholder="ID or title...">
          </div>
          <div class="filter-group">
            <label for="filter-range">Date Range</label>
            <select id="filter-range">
              <option value="">All time</option>
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
          </div>
          <div class="filter-actions">
            <button class="btn btn-ghost" onclick="clearFilters()">Clear</button>
          </div>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>State</th>
              <th>Title</th>
              <th>Created By</th>
              <th>Created</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody id="adrs-body">
            <tr class="empty-row"><td colspan="6" class="loading">Loading records...</td></tr>
          </tbody>
        </table>
      </div>

      <footer class="app-footer fade-in fade-in-3">
        <p>Create ADRs via <code>/adr start</code> in Slack. Track them through draft, acceptance, and beyond.</p>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    let allAdrs = [];

    async function showApp(user) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      const displayName = user.user_metadata?.name || user.user_metadata?.full_name || user.email;
      document.getElementById('user-info').textContent = displayName;
      window._userId = getSlackUserId(user);
      initFilters();
      await loadAdrs();
    }

    function initFilters() {
      const p = new URLSearchParams(location.search);
      if (p.get('state')) document.getElementById('filter-state').value = p.get('state');
      if (p.get('q')) document.getElementById('filter-search').value = p.get('q');
      if (p.get('range')) document.getElementById('filter-range').value = p.get('range');

      document.getElementById('filter-state').addEventListener('change', applyFilters);
      document.getElementById('filter-search').addEventListener('input', applyFilters);
      document.getElementById('filter-range').addEventListener('change', applyFilters);
    }

    function applyFilters() {
      const state = document.getElementById('filter-state').value;
      const q = document.getElementById('filter-search').value.trim().toLowerCase();
      const range = document.getElementById('filter-range').value;

      const p = new URLSearchParams();
      if (state) p.set('state', state);
      if (q) p.set('q', q);
      if (range) p.set('range', range);
      const qs = p.toString();
      history.replaceState(null, '', qs ? '?' + qs : location.pathname);

      renderAdrs(filterAdrs(state, q, range));
    }

    function filterAdrs(state, q, range) {
      let filtered = allAdrs;
      if (state) filtered = filtered.filter(r => r.state === state);
      if (q) {
        filtered = filtered.filter(r => {
          const id = (r.id || '').toLowerCase();
          const title = (r.title || '').toLowerCase();
          return id.includes(q) || title.includes(q);
        });
      }
      if (range) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - parseInt(range));
        filtered = filtered.filter(r => new Date(r.created_at) >= cutoff);
      }
      return filtered;
    }

    function clearFilters() {
      document.getElementById('filter-state').value = '';
      document.getElementById('filter-search').value = '';
      document.getElementById('filter-range').value = '';
      history.replaceState(null, '', location.pathname);
      renderAdrs(allAdrs);
    }

    async function loadAdrs() {
      const { data, error } = await sb.from('adrs')
        .select('*')
        .order('created_at', { ascending: false });

      const tbody = document.getElementById('adrs-body');
      if (error) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="6" class="msg-error">' + esc(error.message) + '</td></tr>';
        return;
      }
      allAdrs = data || [];
      applyFilters();
    }

    function renderAdrs(data) {
      const tbody = document.getElementById('adrs-body');
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="6">No decision records found.</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(r => {
        return '<tr onclick="location.href=\'detail.html?id=' + encodeURIComponent(r.id) + '\'">'
          + '<td class="col-id">' + esc(r.id) + '</td>'
          + '<td><span class="badge badge-' + r.state + '">' + fmtState(r.state) + '</span></td>'
          + '<td>' + esc(r.title) + '</td>'
          + '<td class="col-mono">' + esc(r.created_by) + '</td>'
          + '<td class="col-date">' + fmtDate(r.created_at) + '</td>'
          + '<td class="col-date">' + fmtDate(r.updated_at) + '</td>'
          + '</tr>';
      }).join('');
    }

    initAuth();
  </script>
</body>
</html>
